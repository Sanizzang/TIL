하나의 마이크로서비스를 하나 이상의 인스턴스에서 기동을 시켰을 때 클라이언트 요청이 여러개가 들어왔을 때 그것을 부하분산 처리하기 위해서 우리가 여러개의 인스턴스를 띄울 수 있다.(로드밸런싱) 마이크로서비스를 기동을 할 때, 우리가 서비스 port를 지정하게 되는데, 서비스 port를 0번으로 지정을 하게되면, 랜덤 port가 지정이 되서 여러개의 인스턴스를 실행한다 하더라도 충돌이 발생하지 않는다.

예를 들어, User Service가 Order Service의 어떤 요청을 해서 자기가 필요한 데이터를 가져가고 주문도 한다고 가정했을 때, 2가지 이상의 Order Service를 기동했다고 가정 각각 데이터베이스를 가지고 있다. 이렇게 되면 Order 데이터도 분산 저장되있을 수 밖에 없다. 우리가 사용하고 있는 order라는 마이크로서비스는 독립적인 데이터베이스를 가질 수 있도록 구성을 해놨다.

order-service 인스턴스가 기동이될 때 H2라는 내장DB가 같이 기동이 된다. 각각의 데이터베이스가 각각의 인스턴스에 사용되고 있다.
-> 하나의 주문에 대해서 나눠서 저장되어 있는 주문 데이터 값을 동기화를 어떻게 처리할 것인지 문제가 나온다.

예를 들어 order service를 2가지를 기동 데이터베이스도 2가지로 분산되서 저장

### 데이터 동기화를 어떻게 할 것인가?

#### 1.하나의 Database 사용

물리적으로 떨어져 있는 인스턴스를 하나의 데이터베이스에 저장하기 위해서는 트랜잭션 관리를 잘 해줘야한다.(동시성)

#### 2. Database간의 동기화

각각 1번과 2번의 데이터베이스에서 필요한 데이터 값을 하나씩 전달하는 방법이 아니라 중간에 메시지 큐잉이라는 서버를 통해서(Apache Kafka) 한 쪽에서 발생했던 데이터를 메시지 큐잉 서버에 전달, 메시지 큐잉서버에 변경된 데이터가 있으면 알려달라는 구독신청 -> 두가지 데이터베이스가 동기화가 가능

#### 3. Kafka Connector + DB

하나의 데이터베이스 사용과 데이터 베이스 동기화의 복합 예제

메시지 큐잉 서버를 사용하고 데이터베이스도 하나를 사용
첫 번째 order service 두 번째 order service에서 발생한 데이터를 메시지 큐잉 서버에 메시지를 보내게된다. 메시지 큐잉 서버 자체는 이런 처리를 하기 위해 특화되어 있는 시스템이다 보니 메시지가 전달되면 순차적으로 해석해서 이 메시지를 사용하고자 하는 곳에 사용할 수 있게끔 뿌려주는 중간 매개체(미들웨어) 역할을 한다. 아무리 많은 역할을 한다 하더라도 1초안에 수만건의 데이터를 처리할 수 있는 기술이기 때문에 동시성에 대한 문제라던가 시간적인 배분에 대한 것들은 충분히 해결할 수 있는 능력이 있다.
그리고 메시지 큐잉에 전달된 데이터를 하나의 단일 데이터베이스에 저장한다고 하면 각각의 order service가 자신이 필요한 데이터를 가져갔을때 동일한 데이터베이스를 사용하기 때문에 데이터 간에 일치하지 않는 문제는 해결할 수 있다.
